# 停车场对接

苏琥元

2022.8.30 修订

---  
<!-- TOC -->

- [停车场对接](#停车场对接)
  - [1. 接口文档](#1-接口文档)
  - [2. 领域分析](#2-领域分析)
    - [2.1. 车场管理](#21-车场管理)
    - [2.2. 月卡车辆管理](#22-月卡车辆管理)
    - [2.3. 支付缴费](#23-支付缴费)
    - [2.4. 无牌车出入场景](#24-无牌车出入场景)
    - [2.5. 临时车出入场景](#25-临时车出入场景)
    - [2.6. 月卡车出入场景](#26-月卡车出入场景)
    - [2.7. 月卡续费场景](#27-月卡续费场景)
  - [3. 架构设计](#3-架构设计)
    - [3.1. 整体架构示意](#31-整体架构示意)
    - [3.2. SAAS 业务对接示意](#32-saas-业务对接示意)
    - [3.3. 统一接入标准接口](#33-统一接入标准接口)
    - [3.4. 接入目标](#34-接入目标)
    - [3.5. 程序设计方案](#35-程序设计方案)

<!-- /TOC -->
---  

## 1. 接口文档

停车场 API 调试（内网）： [ParkingLot-middleware API（内网）](http://192.168.0.229:6601/doc.html#/home)

## 2. 领域分析

**停车场业务分析将通过业务模块——场景的结构进行展开**。

停车场业务总的来看可以分成三大部分：

![停车场业务模块](doc/%E9%A2%86%E5%9F%9F%E5%88%86%E6%9E%90/%E5%81%9C%E8%BD%A6%E5%9C%BA%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97.png)

1. 车场管理
2. 月卡车辆管理
3. 支付缴费

### 2.1. 车场管理

停车场的车场管理包括：

- 车位管理
- 通道管理
  - 通道开关
- 车辆出入场
  - 无牌车入场
  - 无牌车出场
  - 临时车入场
  - 临时车出场
  - 月卡车入场
  - 月卡车出场
  - 访客入场
  - 访客出场
- 访客管理(*补充*)

因此可以得到车场管理的基本规则：

![停车场规则](doc/%E9%A2%86%E5%9F%9F%E5%88%86%E6%9E%90/%E5%81%9C%E8%BD%A6%E5%9C%BA%E8%A7%84%E5%88%99.png)

1. 在车场管理中能够对车位进行感知。
2. 在车场管理中能够对通道进行感知与控制。
3. 在车场管理中能够对不同的车辆进出场进行感知。
4. 可以设置访客进出停车场(补充)。
5. 对无牌车与临停车进行订单同步与缴费。

---  

### 2.2. 月卡车辆管理

停车场的月卡车辆管理包括：

- 月卡车基本信息
- 月卡车历史缴费信息
- 月卡车续期

因此可以得到月卡车辆管理的基本规则：

![月卡规则](doc/%E9%A2%86%E5%9F%9F%E5%88%86%E6%9E%90/%E6%9C%88%E5%8D%A1%E8%A7%84%E5%88%99.png)

1. 对车辆在指定停车场的月卡信息进行感知。
2. 对车辆在指定停车场的月卡历史缴费信息进行感知。
3. 对车辆在指定停车场的月卡进行续期。

---  

### 2.3. 支付缴费

支付缴费包括：

- 月卡车续费
- 临停车缴费
- 无牌车缴费

因此可以得到支付缴费的基本规则：

![支付缴费规则](doc/%E9%A2%86%E5%9F%9F%E5%88%86%E6%9E%90/%E6%94%AF%E4%BB%98%E7%BC%B4%E8%B4%B9%E8%A7%84%E5%88%99.png)

1. 月卡车缴费成功后月卡时间得到更新。
2. 临停车通过二维码或小程序查询订单并进行缴费。
3. 无牌车需要通过进场时绑定的账号进行出场缴费。

---  

在场景方面可以划分出无牌车出入场、临时车出入场、月卡车出入场、月卡续费四个场景。

在以上场景中，均涉及到订单的创建以及费用的缴纳这两个场景，其中订单与支付需要包含以下规则：

- 车辆入场时进行订单的创建，并记录车辆入场的记录。
- 车辆缴费时若未创建订单则需要补充创建订单。
- 车辆缴费时补充/完善订单信息并记录车辆出场记录。
- 车辆成功缴费后才能出场，并存在可查询的订单（人工处理除外）。

![订单同步](doc/%E5%9C%BA%E6%99%AF/%E8%AE%A2%E5%8D%95%E5%90%8C%E6%AD%A5.png)

![缴费](doc/%E5%9C%BA%E6%99%AF/%E7%BC%B4%E8%B4%B9.png)

### 2.4. 无牌车出入场景

无牌车入场生成临时车牌时同步生成订单，当无牌车扫码缴费出场时补充订单信息。

![无牌车出入场景](doc/%E5%9C%BA%E6%99%AF/%E6%97%A0%E7%89%8C%E8%BD%A6%E5%87%BA%E5%85%A5%E5%9C%BA%E5%9C%BA%E6%99%AF.png)

- 无牌车首先通过扫码生成临时车牌入场（绑定支付宝或微信）。
- 无牌车出场时使用绑定的账号（绑定支付宝或微信）扫码支付并出场。

### 2.5. 临时车出入场景

临时车入场时记录车牌并同步生成订单，临时车出场时通过小程序或直接扫码进行缴费并补充订单信息。

![临时车出入场景](doc/%E5%9C%BA%E6%99%AF/%E4%B8%B4%E6%97%B6%E8%BD%A6%E5%87%BA%E5%85%A5%E5%9C%BA%E6%99%AF.png)

- 临时车通过小程序查询订单并进行缴费出场。
- 临时车通过扫码进行缴费出场。

### 2.6. 月卡车出入场景

月卡车入场时记录车牌并同步生成订单，出场时完善订单信息并进行出场记录。

![月卡车出入场景](doc/%E5%9C%BA%E6%99%AF/%E6%9C%88%E5%8D%A1%E8%BD%A6%E5%87%BA%E5%85%A5%E5%9C%BA%E6%99%AF.png)

### 2.7. 月卡续费场景

用户通过小程序查询车辆在车场的月卡信息，并对月卡进行续费。

![月卡续费场景](doc/%E5%9C%BA%E6%99%AF/%E6%9C%88%E5%8D%A1%E7%BB%AD%E8%B4%B9%E5%9C%BA%E6%99%AF.png)

---  

## 3. 架构设计

停车场对接应该为 SAAS 嵌入式功能。对于 SAAS 而言可以集成并遥感发现停车场并对停车场提供服务。

因此在架构设计上采取：停车场(接入端适配器)——停车场统一接入标准（见解）—— SAAS平台（行为）为基础理念。

**其中**：

- SAAS 平台通过停车场统一接入标准来与各个停车场进行感知并交互。
- 各停车场接入端通过类 Sidecar 机制接入统一标准提供对应的服务。

### 3.1. 整体架构示意

![停车场对接架构示意图](doc/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/%E5%81%9C%E8%BD%A6%E5%9C%BA%E5%AF%B9%E6%8E%A5%E6%9E%B6%E6%9E%84%E7%A4%BA%E6%84%8F%E5%9B%BE.png)

对 SAAS 业务而言，停车场统一接入标准将停车场细节掩藏并提供统一抽象停车场模型供 SAAS 链接停车场。停车场服务通过统一接入标准对接
SAAS ，提供统一的能力供 SAAS 使用。

通过分层抽象与层内聚合将 SAAS 与具体的停车场业务通过接口抽象隔离与业务聚合连接的方式结合，并达成：

1. 业务对停车场无感知。
2. 停车场对业务无影响。

![停车场对接架构用例示例图](doc/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/%E5%81%9C%E8%BD%A6%E5%9C%BA%E5%AF%B9%E6%8E%A5%E6%9E%B6%E6%9E%84%E7%94%A8%E4%BE%8B%E7%A4%BA%E4%BE%8B.png)

其中停车场统一接入标准与 SAAS 之间通过 RPC 的方式进行连接，统一接入标准与停车场接入适配器中通过简单服务注册与发现的机制链接。

链接端与控制端为类 Sidecar 机制进行相互的链接。

> 链接的方式有：
>
> 1. WEB API ：控制端公开暴露注册与传入接口的 WEB API ，连接端通过注册接口注册并提供自身地址供控制端通过 HTTP 客户端调用。
>
> 2. Socket ： 控制端公开暴露连接地址供连接端链接，通过 TCP/IP 进行通讯。
>
> 3. gRPC ： 控制端公开暴露连接地址，连接端通过注册接口注册并提供自身地址供控制端通过 gRPC 客户端调用。
>
> 4. 本地 ：接入适配器与接入标准位于同一个程序内。

![统一接入标准架构](doc/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/%E7%BB%9F%E4%B8%80%E6%8E%A5%E5%85%A5%E6%A0%87%E5%87%86%E6%9E%B6%E6%9E%84.png)

### 3.2. SAAS 业务对接示意

![停车场对接SAAS业务示意](doc/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/%E5%81%9C%E8%BD%A6%E5%9C%BA%E5%AF%B9%E6%8E%A5SAAS%E4%B8%9A%E5%8A%A1%E7%A4%BA%E6%84%8F.png)

1. 基础能力的获取
  - 通过订单服务获取订单的基本能力
  - 通过 VIP 服务获取 VIP 的基本能力
  - 通过停车场中间件获取远程车场的基本能力
  - 通过租户获取SAAS基本用户信息
2. 通过基础能力完成所需业务
  - 通过使用订单与停车场中间件完成订单的创建与支付
  - 通过使用停车场中间件完成车场信息的获取
  - 通过使用停车场中间与 VIP 服务完成月租车（月卡）的续费（续期）
  - 通过使用租户服务获取调用订单、VIP 等 SAAS 基础服务所需的用户信息

### 3.3. 统一接入标准接口

- 车场管理接口
  - 图片获取
  - 车位查询
  - 获取临时车缴纳金额
  - 临停缴费支付完成
  - 无牌车入场
  - 无牌车出场
  - 根据通道号获取车辆费用
  - 获取入场记录
  - 获取出场记录
  - 获取通道列表
  - 获取通道状态
  - 道闸开关操作
- 月租接口
  - 获取停车场下的月卡费率
  - 获取车辆费率
  - 月租车续期
  - 月租车缴费历史
  - 月租车基本信息
- 优惠券接口（暂定）
  - 查询优惠券
  - 使用优惠券
- 访客预约接口（暂定）
  - 创建访客
  - 修改访客信息
  - 取消访客

### 3.4. 接入目标

接入内容包括：

1. 小程序查询订单支付。
2. 出入场临停车缴费支付。
3. 无牌车出入场缴费支付。

![事项](doc/%E5%AF%B9%E6%8E%A5SaaS%E4%BA%8B%E9%A1%B9.png)

### 3.5. 程序设计方案

停车场中间件领域中各组件关联关系图：

![停车场中间件各组件关联用例](doc/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/%E5%81%9C%E8%BD%A6%E5%9C%BA%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%90%84%E7%BB%84%E4%BB%B6%E5%85%B3%E8%81%94%E7%94%A8%E4%BE%8B.png)

停车场中间件核心领域类图：

![停车场中间件核心领域类图](doc/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/%E5%81%9C%E8%BD%A6%E5%9C%BA%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%A0%B8%E5%BF%83%E9%A2%86%E5%9F%9F%E7%B1%BB%E5%9B%BE.png)

停车场中间件对外提供接口关系类图：

![API类图](doc/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/API%E7%B1%BB%E5%9B%BE.png)  
